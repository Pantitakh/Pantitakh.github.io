{% extends 'app_general/components/base.html' %}

{% block content %}
{% load static %}
<!-- Content of the room detail page starts here -->
<link rel="stylesheet" href="{% static 'css/room_detail.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<!-- pictures -->
<div class="scrolling-gallery">
    <div class="image-container">
        {% if room.image1 %}
        <img src="{{ room.image1.url }}" alt="{{ room.name }}">
        {% else %}
        <img src="enkku.jpg" alt="Default Image">
        {% endif %}
        
        {% if room.image2 %}
        <img src="{{ room.image2.url }}" alt="{{ room.name }}">
        {% else %}
        <img src="enkku.jpg" alt="Default Image">
        {% endif %}
        
        {% if room.image3 %}
        <img src="{{ room.image3.url }}" alt="{{ room.name }}">
        {% else %}
        <img src="enkku.jpg" alt="Default Image">
        {% endif %}
    </div>
</div>

<!-- details -->
<div class="content">
    <div class="details">
        <div class="room">
            <h1>{{ room.name }}</h1>
            <p style="color: black;">Building: {{ room.building }}</p>
            <p style="color: black;">094-.......</p>
            {% if room.has_mic %}<i class="bi bi-mic"></i>{% endif %}
            {% if room.has_camera %}<i class="bi bi-camera"></i>{% endif %}
            {% if room.has_laptop %}<i class="bi bi-laptop"></i>{% endif %}

            <div class="describe">
                <p>{{ room.description }}</p>
            </div>

        </div>

        <div class="describe_line"></div>

        <!-- Booking -->
        <div class="box">
            <div class="booking-widget">
                <h3 id="booking" style="color: black;">Booking</h3>
                {% if room.status == 'Available' %}
                    <form id="booking-form" method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="name">Name:</label>
                            <input type="text" id="name" name="name" value="{{ user.get_full_name }}">
                        </div>
                        <div class="form-group">
                            <label for="booking_date">Select Booking Date:</label>
                            <input type="date" id="booking_date" name="booking_date" required>
                        </div>
                        <div class="form-group">
                            <label for="start_time">Start Time:</label>
                            <input type="time" id="start_time" name="start_time" required>
                        </div>
                        <div class="form-group">
                            <label for="end_time">End Time:</label>
                            <input type="time" id="end_time" name="end_time" required>
                        </div>
                        <div class="form-group">
                            <label for="purpose">Purpose:</label>
                            <input type="text" id="purpose" name="purpose" required>
                        </div>
                        <div class="form-group">
                            <label for="details">Details:</label>
                            <textarea id="details" name="details" rows="3"></textarea>
                        </div>
                        <button type="submit" class="button">Book</button>
                    </form>
                {% else %}
                    <p class="alert alert-danger">This room is currently not available for booking.</p>
                {% endif %}
            </div>
        </div>

        <!-- Review Form -->
        <form class="review">
            <h3 style="color: black;">Review</h3>
            <div class="booking_line"></div>
            <div class="col-md-4">
                <label>Name:</label>
                <input type="text" placeholder="Name" value="" />
            </div>
            <div>
                <label>Review:</label>
                <textarea cols="40" placeholder="Your Message..." rows="3"></textarea>
            </div>
            <button class="button">Submit Review</button>
        </form>
    </div>

    <div class="container">
        <div class="status-box">
            <h2 class="status {% if room.status == 'Available' %} available {% elif room.status == 'Booked' %} booked 
            {% elif room.status == 'Unavailable' %} unavailable {% endif %}">{{ room.status }}</h2>
           
        </div>        

        <!-- Timing Section -->
        <div class="time">
            <h3>Open</h3>
            <ul>
                <li>{{ room.day }} 
                    <span>{{ room.open_time|date:"h:i A" }} - {{ room.close_time|date:"h:i A" }}</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    document.getElementById('booking-form').addEventListener('submit', function(e) {
        e.preventDefault();

        let form = this;
        let formData = new FormData(form);

        fetch('{% url "create_booking" room.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);  // Booking successful
                form.reset();
            } else if (data.status === 'error') {
                alert(data.message);  // Show the exact error message returned from the backend
            } else {
                alert('Error creating booking. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });
</script>
{% endblock %}